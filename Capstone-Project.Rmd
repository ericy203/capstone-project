---
title: "NFL_Project"
author: "Eric Young"
date: "8/13/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Predicting the Longevity of NFL Players

The goal of this project is to predict the length of a NFL players career. I will use data that is known about the player coming into the NFL and exclude data about the players performance throughout the seasons they played in the NFL. The success criteria will be based on 3 years, meaning if a player plays 3 years in the NFL they were succesful to draft for the team otherwise they were unsuccessful. I have based the 3 year mark on current length of contract terms set by the NFL which are 3 years for undrafted players and 4 years for drafted. 

I will start the prediction from the beginning of their rookie season from the point at which they are drafted and will not be using any performance data from the NFL data set. I will be using data from the CollegeballR package to determine if a player will be drafted in to the NFL.  

--There are three groups to consider 1. Go professional 1a last 3 years 1b don't las 3 years, 2. Don' go professional -- category years for those who go professional and N/A for those who don't

## Potential Clients

The client for this project would be the NFL, the teams, players, and agents. The information provided could help the NFL change the length of base contracts and reasses base pay for players. It would provide information to the teams for how long a player will last and analyze how much they should pay in signing bonuses. It would inform players and agents for how much of a signing bonus they should push for. 

### Source of data

There are two data sets which I will be using for this capstone project. The first source dataset is from Kaggle and is named [NFL Statistics](https://www.kaggle.com/kendallgillies/nflstatistics). The second source comes from GitHub a package created by Meyappan called [collegeballR](https://github.com/meysubb/collegeballR).

When trying to tie team_stats to the data frame I found a bug in the team_stats.R where it was not looking up sport and giving an error. I had to fork the original dataset into [my repository](https://github.com/ericy203/collegeballR/) and edit the code. 

The original size of the basic_stats data frame is 17,172 rows and 17 columns. Since the data from the collegeballR package is only available from 2014 - 2018 I will only be covering those years in the two data sets.

The variables I will use to predict are:

* Age
* Birth Place
* College - massage it into something else. What about college could influence how well you do in the NFL
PAC12- BIG 10, D1, D2, small college re classify into 5 - 10. 
Another way to do it is change college to rank. According to year. If you could pull the ranks from their senior year. Quantitative instead of categorical. 
* Position
* Initial Team
* Height
* Weight
* BMI 



### Deliverables

The deliverables for this project will be:

* NFL_Project.R - this is the file with all of the code
* Capstone-Project.Rmd - this file has the analysis
* Output of project file as a PDF
* Deck of slides with plots


#####Libraries used

Below are the libraries which I will be using in the capstone project. The collegeballR package is from GitHub and you will need to use devtools to install it.

```{r echo = FALSE}
library(devtools)
library(readr) 
library(dplyr)
library(tidyr)
library(ggplot2)
library(xtable)
library(collegeballR)
library(knitr)
library(kableExtra)
library(ROCR)
library(pROC)
library(caTools)
```
##NFL Data Set Import
Set the working directory and read in the Basic Stats file

```{r}
basic_stats <- read.csv("nflstatistics/Basic_Stats.csv", header = TRUE, stringsAsFactors = FALSE)
```

##NCAA Data Set Import
We need to import the collegedf data set which has all of our NCAA player and team information.
```{r}
collegedf <- read.csv("./nflstatistics/college_data.csv", header = TRUE, stringsAsFactors = FALSE)
```

##NFL & NCAA Joined Data Set Import
```{r}
college_draft <- read.csv("./nflstatistics/college_draft.csv")
```


--Clean the two data sets in different sections
###Clean Basic Stats (NFL Data)

Let's check the data and basic information on basic_stats
-xtable turn summary into a table
```{r}
xtable(summary(basic_stats))
```

Check for "" in the Experience column
```{r}
basic_stats$Experience[basic_stats$Experience==""] <- NA
```

seperate Years.Played into two columns so we can calculate experience and replace the ""
```{r}
basic_stats <- separate(basic_stats, Years.Played, c("start_year", "end_year"), sep = "-")
```

create a difference of end_year and start_year
```{r}
year_difference <- (as.numeric(basic_stats$end_year) - as.numeric(basic_stats$start_year))
```

calculate experience for "" and replace
```{r}
basic_stats$Experience[is.na(basic_stats$Experience)]<- year_difference[is.na(basic_stats$Experience)]
```

Converting Experience variable into number of seasons
creating a vector named v
```{r}
v <- basic_stats$Experience
```

Change rookie to 0 
```{r}
v[grepl("[rR]ookie", basic_stats$Experience)] <- "0"
```

Strip all values except for digites from the string
```{r}
v <- gsub("[^0-9]", "", v)
```

Assign integers to basic_stats$Experience from v
```{r}
basic_stats$Experience <- as.integer(v)
```


####Basic Statistics for NFL data

Look at the average career for a player 
```{r}
mean(basic_stats$Experience, na.rm = TRUE)
```

#Clean College Ball R
The CollegeBallR package was a data set found on Github but we had many issues using this data set. So we had to pull the data directly from the NCAA website and create our own data frame. The data frame had the below issues which needed to be fixed.

1. Pull all combinations for each team and season from the NCAA website.
2. Dropped all players which didn't have a position
 - The players didn't have a position because they didn't play that season.
3. Dropped all years that were N/A
4. Relabled positions and statndardized them.
 - For example WILL is a type of Line Backer so I relabled them as LB
5. Created csv to be be used later in the project.



#Create and Clean College_draft
To create the data frame College_draft I did a left join on the NCAA and NFL data frames.
By creating this data frame we were able to analyze how many players were drafted from college into the NFL and from which teams. However, there were some data problems that I needed to fix which I will list below.

1. Create logical variable of TRUE or FALSE if the player was drafted into the NFL.
2. Sanitized the column names and stripped out invalid characters.
3. Remove comma from rushing yards variables.
4. Change games played and games started variables to numeric.
5. Created a new variable games not started.
6. Dropped all NULL positions from the data set.
7. Created a cleaned version of the csv to be be used later in the project.

##NFL Plots
One question that may be asked while reviewing NFL player data is are the players bigger now than they were when the NFL started. In the chart below we see that players now weigh aproximately 60 to 70 lbs more than in the 1920's. From 1920 to around 2000 there was a steady increase in the weight of the players. Since 200 the average weight of players has stayed about the same. The below chart shows the mean weight of football players has increased from 1920 to 2018.
```{r}
ggplot(basic_stats) +
  aes(x = as.numeric(start_year), y = Weight..lbs.) +
  geom_point() +
  geom_smooth() +
  labs(x = "Year", y = "Weight in Lbs")
```

Another question that may be asked is are player taller today then they were when the NFL started. The answer is yes, the average height in 1920 was about 70 inches and dramatically increased until about 1970 where players are an average height of 74 inches. This chart shows the average height in the NFL hit its peak in the 1970s and is close to the same today.

What is interesting about the chart below is all of the plots are evely placed and staggered. The reason for this is when a team records the height of a player they don't measue in quarter or half of an inch they will round up to the nearest inch.
```{r, warning=FALSE, message=FALSE}
ggplot(basic_stats) +
  aes(x = as.numeric(start_year), y = Height..inches.) +
  geom_point() +
  geom_smooth() +
  labs(x = "Year", y = "Height in Inches")
```

The density plot below shows the difference in height between all of the NFL teams. The most common height in the NFl seems to be around 75 inches. Players who are drafted and play in the NFL are usually between 70 and 77 inches in height. This means if you are below 70 inches it is still possible to be drafted but you'll have to be an excellent athlete to make it into the NFL. On the other hand there are a few players who are in the NFL at 80 inches or about 6 feet 8 inches. 
```{r, warning=FALSE}
ggplot(basic_stats, aes(Height..inches., fill = Current.Team)) +
         geom_density() +
  facet_wrap(~Current.Team) +
  guides(fill = "none") +
  labs(x = "Height in Inches")
```

The box and whisker plot below shows us the lowest observation, highest oservation, the four quartiles, and average years of experience for each NFL team. For many of the teams the first quartile is 0 meaning 1 in 4 players are rookies. There are 19 teams with 3 years of median experience and 12 teams with 2 years of median experience. This means most players in the NFL have between 2 and 3 years of experience. It looks like 75% of players will retire between 5 and 7 years of playing in the NFL. The New Orleans Saints have the highest observation of years of experience and third quartile of player retiring. Almost every team has outliers and what is surprising is some players have over 15 years in the NFL.
```{r}
ggplot(basic_stats, aes(Current.Team, Experience)) +
  geom_boxplot() +
  labs(x = "NFL Teams", y = "Years of Experience") +
  coord_flip()
```


##Collegeball R Plots
This bar plot shows the distribution of players by year, season and the progression of players from Freshman, Sophmore, Junior, and Senior by year. The amount of players progressing from one year to the next is never the same for any of the years. Senior year is always lower than the previous Junior year. This could be because of players moving into the NFL before completeing their Senior year. The increase of players in the Sophmore and Junior years could be caused by players transferring from Junior Colleges. 
```{r}
ggplot(collegedf, aes(season, fill = Yr, group = Yr)) +
  geom_bar(position = "dodge")
```

The below chart shows by the number of attempts how many yards are lost. The natural thought would be the more rushing attempts a player has the more likely they are to lose yardage. To an extent this is true. However we see in the scatter plot that this isn't exactly true. We can see players who have rushed nearly 400 times and have only lost around 50 yards. Then there is another group who have rushed far less times but have lost a lot more yardage.
```{r, warning=FALSE}
ggplot(collegedf, aes(x = `Rush.Attempts`, y = `Rush.YdsLost`)) +
  geom_point()
```

The below chart shows by year how many players played each position and displays them by year. We can see that there is variation for every position from year to year. It is not uncommon for a player to switch positions, for example a wide receiver may switch to a Defensive Back from one year to the next. Another senario is a player transfers from a junior college to a university and that will cause a difference in count from one year to the next. Players may also leave for the NFL draft after their Junior year and this can cause a drop in the number of players for the positions. Another thing we can look at is some positions like Punter and Kicker have far fewer players in these positions than Defensive Back or Offensive Lineman. These positions only require a few players per team as there is only one slot on the field for them and they are less likely to get injured. Where as Defensive Backs and Offensive Linemen take up multiple spots on a field and are far more likely to get injured.
```{r}
ggplot(collegedf, aes(Pos, fill = Yr, group = Yr)) +
  geom_bar(position = "dodge") +
  coord_flip()
```

Define college_teams data frame 
```{r}
college_teams <- inner_join(collegedf, basic_stats, by = c("team_name" = "College", "Player" = "Name")) 
```

The below chart shows us the colleges which have at least one or more players drafted into the NFL from 2014 onwards. The two teams with the highest number of drafted players are Michigan and Stanford tied with 7 players drafted into the NFL. This chart can give us an idea of which schools consistently send players to the NFL and can even give us an idea of how competitive they are in the NCAA. The idea to the last notion is the more players which are drafted would mean the teams have more highly skilled players which in turn could mean the team was more competitive. The toal number of players drafted between 2014 and 2017 is 2735.
```{r, eval=FALSE}
table(college_draft$was_drafted)
```

```{r, fig.height=10}
ggplot(filter(college_teams, start_year >= 2014), aes(x = team_name)) +
  geom_bar() +
  coord_cartesian(ylim=c(2,7)) +
  coord_flip() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=20,face="bold"))
```

--Include high level statistics and aggregate data not raw data

#Linear and Logistic Regression
 #Linear Model for experience
```{r}
nfl_model <- lm(Experience ~ College, data = basic_stats)
```


```{r}
SSE <- sum(nfl_model$residuals^2)
SSE
```


Plot of nfl_model
```{r}
plot(nfl_model)
```


```{r}
nfl_model2 <- lm(Experience ~ College + Weight..lbs., data = basic_stats)
```


```{r}
SSE2 <- sum(nfl_model2$residuals^2)
SSE2
```


```{r}
nfl_model3 <- lm(Experience ~ Height..inches. + Weight..lbs., data = basic_stats)
```


```{r}
SSE3 <- sum(nfl_model3$residuals^2)
SSE3
```


#Linear Model for drafting
```{r}
draft1 <- lm(was_drafted ~ poly(Height..inches., 2) + Weight..lbs., data = na.omit(college_draft[c("Height..inches.", "Weight..lbs.", "was_drafted")]))
summary(draft1)
```


```{r}
draft2 <- lm(was_drafted ~ Yr + Pos + GP + Rush.Attempts + Rush.Net.Yards + Rush.YdsGained, data = college_draft)
summary(draft2)
```

##Differences in the drafting rates for position
The number of drafted players per position will come down to how many slots on the field utilize that position. Punters and kickers are one of the least drafted positions because there only needs to be one of them on the field and are not utilized very frequently. This will also mean punters and kickers will be less likely to get injured so they will have longer careers. So the need to draft a kicker or punter isn't as necessary as a position like an Offensive Lineman or Defensive Lineman. These two positions will play every snap on offense or defense and they are always in the mix. For these positions injuries occur a lot more frequently and career length will be shorter. 
```{r}
ggplot(college_draft) + aes(x=Pos, fill = was_drafted) + geom_bar()
```



#Logistic Regression
```{r}
set.seed(122)
split <- sample.split(college_draft$was_drafted, SplitRatio = 0.75)
```


#create training set
```{r}
college_draftTrain <- subset(college_draft, split == TRUE)
nrow(college_draftTrain)
```

#Run the model on Train
The subset has all colleges where at least one player was drafted
```{r}
college_draftTrain <- subset(college_draftTrain, ave(college_draftTrain$was_drafted, college_draftTrain$team_name, FUN=sum) > 0)
```

#Build the Logistic Regression Model
```{r}
college_draftLog <- glm(was_drafted ~ GP + Pos + Yr + team_name, family = binomial(), college_draftTrain)
```

#Check why LS only has values for 2018
```{r}
subset(college_draft, college_draft$Pos == "LS" & season == 2017)
```

#Build prediction of college_draftLog
```{r}
predict_college_draftTrain <- predict(college_draftLog, newdata = college_draftTrain, type = "response")
summary(predict_college_draftTrain)
```

#To get the fn, fp, tn, tp
```{r}
table(college_draftTrain$was_drafted, predict_college_draftTrain > mean(college_draftTrain$was_drafted))
```

#average predicted probabilities
```{r}
tapply(predict_college_draftTrain, college_draftTrain$was_drafted,  FUN=mean)
```
#Precision and recall
#Accuracy
```{r}
(9887 + 1616)/(9887 + 4862 + 447 + 1616)
```
#ROC Curve
```{r}
ROCRpred_Train <- prediction
```

#create testing set
```{r}
college_draftTest <- subset(college_draft, split == FALSE)
college_draftTest <- subset(college_draftTest, college_draftTest$team_name %in% college_draftTrain$team_name)
nrow(college_draftTest)
```

#Test prediction on Test data set
```{r}
predict_Test <- predict(college_draftLog, newdata = college_draftTest, type = "response" )
summary(predict_Test)
table(college_draftTest$was_drafted, predict_Test > mean(college_draftTrain$was_drafted))
```

#Accuracy
```{r}
(3479 + 544)/(3479 + 1593 + 144 + 544)
```

#ROC Curve
```{r}
ROCRpred_Test <- prediction(predict_Test, college_draftTest$was_drafted)
ROCRperf_Test <- performance(ROCRpred_Test, "tpr", "fpr")
plot(ROCRperf_Test)
```


#Logistic Regression 2
#create training set
```{r}
college_draftTrain2 <- subset(college_draft, split == TRUE)
nrow(college_draftTrain2)
```

#Run the model on Train2
#the subset has all colleges where at least one player was drafted
```{r}
college_draftTrain2 <- subset(college_draftTrain2, ave(college_draftTrain2$was_drafted, college_draftTrain2$team_name, FUN=sum) > 0)
```

#Build the Logistic Regression Model
```{r}
college_draftLog2 <- glm(was_drafted ~ Pos + GP + GS + season + team_name, family = binomial(), college_draftTrain2)
summary(college_draftLog2)
```

#Build prediction of college_draftLog2
```{r}
predict_college_draftTrain2 <- predict(college_draftLog2, newdata = college_draftTrain2, type = "response")
summary(predict_college_draftTrain2)
```

#Get the fn, fp, tn, tp
```{r}
table(college_draftTrain2$was_drafted, predict_college_draftTrain2 > mean(college_draftTrain2$was_drafted))
```

#average predicted probabilities
```{r}
tapply(predict_college_draftTrain2, college_draftTrain2$was_drafted,  FUN=mean)
```

#Accuracy
```{r}
(11291 + 1651)/(11291 + 3456 + 412 + 1651)
```

#create testing set
```{r}
college_draftTest2 <- subset(college_draft, split == FALSE)
nrow(college_draftTest2)
```

#the subset has all colleges where at least one player was drafted in test
```{r}
college_draftTest2 <- subset(college_draftTest2, ave(college_draftTest2$was_drafted, college_draftTest2$team_name, FUN=sum) > 0)
```

#Build test prediction of college_draftTestLog
```{r}
predict_cdTest2 <- predict(college_draftLog2, newdata = college_draftTest2, type = "response")
summary(predict_cdTest2)
```

#To get the fn, fp, tn, tp
```{r}
table(college_draftTest2$was_drafted, predict_cdTest2 > mean(college_draftTest2$was_drafted))
```

#average predicted probabilities on Test
```{r}
tapply(predict_cdTest2, college_draftTest2$was_drafted, FUN=mean)
```

#Accuracy
```{r}
(3811 + 558)/(3811 + 1181 + 130 + 558)
```

#ROC Curve
```{r}
ROCRpred_Test2 <- prediction(predict_cdTest2, college_draftTest2$was_drafted)
ROCRperf_Test2 <- performance(ROCRpred_Test2, "tpr", "fpr")
plot(ROCRperf_Test2)
```
#Trying to stack ROC plots
```{r}
plot(ROCRperf_Test, col = 552, lty = 1, main = "ROC")
plot(ROCRperf_Test2, col = 24 , lty = 2, add = TRUE)
```

